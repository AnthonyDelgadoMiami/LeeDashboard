<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emily's Spotify - Lee's Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/index.css}" rel="stylesheet">
    <link th:href="@{/css/header.css}" rel="stylesheet">
    <style>
        .music-card {
          transition: transform 0.2s ease-in-out;
          border: none;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .music-card:hover {
          transform: translateY(-5px);
        }
        .album-art {
          border-radius: 8px;
          object-fit: cover;
        }
        .spotify-green {
          color: #1DB954;
        }
        .track-item {
          border-left: 3px solid #1DB954;
        }
        .last-updated {
          font-size: 0.8rem;
          color: #666;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h1>üéµ Emily's Spotify</h1>

    <div class="p-3 mb-4 bg-secondary bg-gradient text-white rounded">
        <p>Hey mi amor! This is my Spotify dashboard where you can see my playlists and favorite tracks.
            You can play song previews right here and discover new music I'm enjoying!
            It's our personal music sharing space ‚ù§Ô∏è</p>
    </div>

    <!-- Error Message -->
    <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
        <strong>Note:</strong> <span th:text="${error}"></span>
        <br><small>This could be due to Spotify API limits. The page will show some default music data instead.</small>
    </div>

    <!-- Spotify Content -->
    <div class="row" th:if="${spotifyData != null}">

        <!-- Profile -->
        <div class="col-md-4">
            <div class="card music-card mb-4">
                <div class="card-body text-center">
                    <img th:if="${profile.imageUrl}" th:src="${profile.imageUrl}"
                         class="album-art mb-3" width="120" height="120"
                         onerror="this.style.display='none'">
                    <div th:unless="${profile.imageUrl}"
                         class="album-art mb-3 mx-auto bg-success bg-opacity-25 d-flex align-items-center justify-content-center"
                         style="width: 120px; height: 120px;">
                        <span class="display-4">üéµ</span>
                    </div>
                    <h4 th:text="|${profile.displayName}'s Music|">Emily's Music</h4>
                    <p class="text-muted" th:text="${profile.email}"></p>
                    <div class="mt-3">
                        <a href="https://open.spotify.com/user/emily" target="_blank" class="btn btn-success">
                            <i class="bi bi-spotify"></i> Open Full Spotify
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card music-card mb-4">
                <div class="card-body">
                    <h6 class="card-title">üìä Music Stats</h6>
                    <div class="d-flex justify-content-between text-center mb-3">
                        <div>
                            <div class="h5 mb-0" th:text="${spotifyData.playlists != null ? spotifyData.playlists.size() : '0'}"></div>
                            <small class="text-muted">Playlists</small>
                        </div>
                        <div>
                            <div class="h5 mb-0" th:text="${spotifyData.topTracks != null ? spotifyData.topTracks.size() : '0'}"></div>
                            <small class="text-muted">Recent Tracks</small>
                        </div>
                        <div>
                            <div class="h5 mb-0" th:text="${spotifyData.playlists != null ? #aggregates.sum(spotifyData.playlists.![trackCount]) : '0'}"></div>
                            <small class="text-muted">Total Tracks</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most Played Track -->
            <div class="card music-card mb-4" th:if="${spotifyData.mostPopularTrack != null}">
                <div class="card-body">
                    <h6 class="card-title d-flex justify-content-between align-items-center">
                        <span>üî• Most Played</span>
                        <small class="text-muted">Past 7 days</small>
                    </h6>
                    <div class="track-item p-3">
                        <div class="d-flex align-items-center mb-2">
                            <img th:if="${spotifyData.mostPopularTrack.imageUrl != null}"
                                 th:src="${spotifyData.mostPopularTrack.imageUrl}"
                                 class="album-art me-3" width="50" height="50"
                                 onerror="this.style.display='none'">
                            <div th:unless="${spotifyData.mostPopularTrack.imageUrl != null}"
                                 class="album-art me-3 bg-warning bg-opacity-25 d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px;">
                                <span class="text-muted">üî•</span>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0" th:text="${spotifyData.mostPopularTrack.name}">Most Played Track</h6>
                                <small class="text-muted" th:text="${spotifyData.mostPopularTrack.artist}">Artist</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" th:text="${spotifyData.mostPopularTrack.formattedDuration}">0:00</small>
                            <button class="btn btn-success btn-sm"
                                    th:attr="data-track-id=${spotifyData.mostPopularTrack.trackId}"
                                    th:disabled="${spotifyData.mostPopularTrack.trackId == null}"
                                    onclick="playFeaturedTrack(this, 'most-popular-player')">
                                <i class="bi bi-spotify"></i> Play
                            </button>
                        </div>
                        <!-- Hidden Player -->
                        <div class="spotify-player-container mt-2" id="most-popular-player" style="display: none;">
                            <iframe th:if="${spotifyData.mostPopularTrack.trackId != null}"
                                    th:attr="src=${'https://open.spotify.com/embed/track/' + spotifyData.mostPopularTrack.trackId + '?utm_source=generator&theme=0'}"
                                    width="100%"
                                    height="152"
                                    frameborder="0"
                                    allowfullscreen=""
                                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                    loading="lazy"
                                    class="spotify-embed">
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Last Played Track -->
            <div class="card music-card mb-4" th:if="${spotifyData.lastAddedTrack != null}">
                <div class="card-body">
                    <h6 class="card-title d-flex justify-content-between align-items-center">
                        <span>‚è∞ Last Played</span>
                        <small class="text-muted">Recently</small>
                    </h6>
                    <div class="track-item p-3">
                        <div class="d-flex align-items-center mb-2">
                            <img th:if="${spotifyData.lastAddedTrack.imageUrl != null}"
                                 th:src="${spotifyData.lastAddedTrack.imageUrl}"
                                 class="album-art me-3" width="50" height="50"
                                 onerror="this.style.display='none'">
                            <div th:unless="${spotifyData.lastAddedTrack.imageUrl != null}"
                                 class="album-art me-3 bg-info bg-opacity-25 d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px;">
                                <span class="text-muted">‚è∞</span>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0" th:text="${spotifyData.lastAddedTrack.name}">Last Played Track</h6>
                                <small class="text-muted" th:text="${spotifyData.lastAddedTrack.artist}">Artist</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" th:text="${spotifyData.lastAddedTrack.formattedDuration}">0:00</small>
                            <button class="btn btn-success btn-sm"
                                    th:attr="data-track-id=${spotifyData.lastAddedTrack.trackId}"
                                    th:disabled="${spotifyData.lastAddedTrack.trackId == null}"
                                    onclick="playFeaturedTrack(this, 'last-played-player')">
                                <i class="bi bi-spotify"></i> Play
                            </button>
                        </div>
                        <!-- Hidden Player -->
                        <div class="spotify-player-container mt-2" id="last-played-player" style="display: none;">
                            <iframe th:if="${spotifyData.lastAddedTrack.trackId != null}"
                                    th:attr="src=${'https://open.spotify.com/embed/track/' + spotifyData.lastAddedTrack.trackId + '?utm_source=generator&theme=0'}"
                                    width="100%"
                                    height="152"
                                    frameborder="0"
                                    allowfullscreen=""
                                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                    loading="lazy"
                                    class="spotify-embed">
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-8">

            <div class="card music-card mb-4">
                <div class="card-header bg-success bg-opacity-25 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">‚≠ê Recently Added</h5>
                    <small class="text-muted">Latest from my playlists</small>
                </div>
                <div class="card-body">
                    <div th:if="${recentTracks != null && !recentTracks.empty}">
                        <div th:each="track, stat : ${recentTracks}"
                             class="list-group-item track-item p-3 mb-2"
                             th:id="'recent-track-' + ${stat.index}">
                            <div class="d-flex align-items-center">
                                <!-- Track Number -->
                                <div class="me-3 text-center" style="width: 30px;">
                                    <span class="text-muted" th:text="${stat.index + 1}"></span>
                                </div>

                                <!-- Track Art -->
                                <img th:if="${track.imageUrl != null}" th:src="${track.imageUrl}"
                                     class="album-art me-3" width="50" height="50"
                                     onerror="this.style.display='none'">
                                <div th:unless="${track.imageUrl != null}"
                                     class="album-art me-3 bg-secondary d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px;">
                                    <span class="text-muted">üéµ</span>
                                </div>

                                <!-- Track Info -->
                                <div class="flex-grow-1">
                                    <h6 class="mb-1" th:text="${track.name}">Unknown Track</h6>
                                    <p class="mb-0 text-muted" th:text="${track.artist}">Unknown Artist</p>

                                    <!-- Preview Availability Indicator -->
                                    <div class="preview-indicator">
                            <span th:if="${track.previewUrl != null}" class="text-success">
                                <i class="bi bi-check-circle"></i> Preview available
                            </span>
                                        <span th:if="${track.previewUrl == null}" class="text-muted">
                                <i class="bi bi-music-note"></i> Full song via Spotify
                            </span>
                                    </div>
                                </div>

                                <!-- Duration -->
                                <div class="ms-3 duration" th:text="${track.formattedDuration}">0:00</div>

                                <!-- Spotify Player Toggle -->
                                <div class="ms-3">
                                    <button class="btn btn-success btn-sm player-toggle-btn"
                                            th:attr="data-track-id=${track.trackId}, data-track-index=${stat.index}"
                                            th:disabled="${track.trackId == null}"
                                            th:title="${track.trackId == null ? 'Cannot load Spotify player' : 'Toggle Spotify player'}"
                                            onclick="toggleSpotifyPlayer(this)">
                                        <i class="bi bi-spotify"></i>
                                        <span class="player-text">Play</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Spotify Player Container (hidden by default) -->
                            <div class="spotify-player-container mt-3"
                                 th:attr="id=${'recent-player-container-' + stat.index}"
                                 style="display: none;">
                                <iframe th:if="${track.trackId != null}"
                                        th:attr="src=${'https://open.spotify.com/embed/track/' + track.trackId + '?utm_source=generator&theme=0'}"
                                        width="100%"
                                        height="152"
                                        frameborder="0"
                                        allowfullscreen=""
                                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                        loading="lazy"
                                        class="spotify-embed">
                                </iframe>
                                <div th:unless="${track.trackId != null}" class="alert alert-warning text-center">
                                    <i class="bi bi-exclamation-triangle"></i> Spotify player not available for this track
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:unless="${recentTracks != null && !recentTracks.empty}">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-music-note-beamed display-4"></i>
                            <p>Recent tracks will appear here</p>
                            <small class="text-muted">Tracks from your playlists will show up here</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Playlists -->
            <div class="card music-card">
                <div class="card-header bg-warning bg-opacity-25 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">üìö My Playlists</h5>
                    <small class="text-muted" th:text="'Total: ' + (${spotifyData.playlists != null ? spotifyData.playlists.size() : '0'})"></small>
                </div>
                <div class="card-body">
                    <div th:if="${spotifyData.playlists != null && !spotifyData.playlists.empty}">
                        <div class="row">
                            <div th:each="playlist : ${spotifyData.playlists}" class="col-md-6 mb-3">
                                <div class="d-flex align-items-center p-3 border rounded music-card"
                                     style="cursor: pointer;"
                                     th:data-playlist-id="${playlist.id}"
                                     onclick="openPlaylist(this)">
                                    <img th:if="${playlist.imageUrl}" th:src="${playlist.imageUrl}"
                                         class="album-art me-3" width="70" height="70"
                                         onerror="this.style.display='none'">
                                    <div th:unless="${playlist.imageUrl}"
                                         class="album-art me-3 bg-warning bg-opacity-25 d-flex align-items-center justify-content-center"
                                         style="width: 70px; height: 70px;">
                                        <span class="fs-4">üéµ</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" th:text="${playlist.name}"></h6>
                                        <small class="text-muted d-block" th:text="${playlist.trackCount + ' tracks'}"></small>
                                        <small class="text-muted" th:if="${playlist.description}" th:text="${playlist.description}"></small>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm ms-2"
                                            th:data-playlist-id="${playlist.id}"
                                            onclick="openPlaylistFromButton(this)">
                                        View Songs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:unless="${spotifyData.playlists != null && !spotifyData.playlists.empty}">
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-collection-play display-1"></i>
                            <p class="mt-2">Playlists will appear here once connected</p>
                            <small>Make sure your Spotify playlists are set to public</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script>
    function openPlaylist(element) {
      const playlistId = element.getAttribute('data-playlist-id');
      if (playlistId && playlistId !== 'null') {
        window.location.href = '/spotify/playlist/' + playlistId;
      } else {
        console.error('Invalid playlist ID');
      }
    }

    function openPlaylistFromButton(button) {
      const playlistId = button.getAttribute('data-playlist-id');
      if (playlistId && playlistId !== 'null') {
        window.location.href = '/spotify/playlist/' + playlistId;
      } else {
        console.error('Invalid playlist ID');
      }
      // Prevent the click from bubbling to the parent div
      event.stopPropagation();
    }
</script>
<script th:src="@{/js/newlyAdded.js}"></script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>